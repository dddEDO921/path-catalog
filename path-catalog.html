<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Path Catalog</title>

  <!-- 外部CDN OKとのことなので Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ちょい補助：テキスト省略 */
    .line-clamp-2{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100">
  <div class="min-h-dvh grid grid-cols-1 md:grid-cols-[260px_1fr]">

    <!-- Sidebar -->
    <aside class="border-r border-slate-800 bg-slate-900">
      <div class="p-4 sticky top-0">
        <div class="flex items-center justify-between gap-2">
          <h1 class="text-lg font-semibold tracking-tight text-white">Path Catalog</h1>
          <span class="text-[11px] text-slate-400" id="stats"></span>
        </div>

        <div class="mt-3 text-xs text-slate-400" id="toast"></div>

        <div class="mt-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xs font-semibold text-slate-200">カテゴリ</h2>
            <button id="toggleSidebar"
                    class="md:hidden text-xs text-slate-300 underline underline-offset-2">
              閉じる
            </button>
          </div>

          <nav class="mt-2 space-y-1" id="catList"></nav>
        </div>

        <div class="mt-4">
          <h2 class="text-xs font-semibold text-slate-200">サブカテゴリ</h2>
          <nav class="mt-2 space-y-1" id="subList"></nav>
        </div>

        <div class="mt-4 text-[11px] text-slate-400">
          <p>操作:</p>
          <ul class="list-disc ml-4 mt-1 space-y-1">
            <li>カテゴリ → サブカテゴリの順に絞り込み</li>
            <li>カードをクリックするとパスをコピー</li>
          </ul>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="p-4 md:p-5">
      <!-- Mobile header -->
      <div class="md:hidden mb-4 flex items-center justify-between">
        <button id="openSidebar"
                class="rounded-xl border border-slate-800 bg-slate-900 px-3 py-2 text-sm text-slate-100 hover:bg-slate-800">
          カテゴリ
        </button>
        <div class="text-xs text-slate-400" id="statsMobile"></div>
      </div>

      <div class="mb-2"></div>

      <section id="list" class="space-y-3"></section>

      <section id="empty" class="hidden mt-10">
        <div class="rounded-2xl border border-dashed border-slate-800 bg-slate-900 p-10 text-center text-slate-300">
          条件に一致するデータがありません
        </div>
      </section>
    </main>
  </div>

  <script src="data.js"></script>

  <script>
    (() => {
      // DOM helper / 安全変換
      const $ = (id) => document.getElementById(id);
      const safe = (v) => (v ?? "").toString();
      const escapeHtml = (str) => str.replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
      const uniq = (arr) => Array.from(new Set(arr));
      const sortJa = (arr) => arr.slice().sort((a,b)=>a.localeCompare(b, "ja"));
      const typeIcon = {
        url: `<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M10.5 13.5 7 17a4 4 0 1 1-5.7-5.6l4-4a4 4 0 0 1 5.6 0M13.5 10.5 17 7a4 4 0 0 1 5.7 5.6l-4 4a4 4 0 0 1-5.6 0"/><path d="m8 16 8-8"/></svg>`,
        file: `<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M7 3h7l5 5v11a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M14 3v5h5"/></svg>`,
        folder: `<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/></svg>`,
        unknown: `<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 9a2.5 2.5 0 1 1 3.9 2 2.5 2.5 0 0 0-1.4 2.2V14"/><path d="M12 18.01l.01-.011"/><rect x="4" y="4" width="16" height="16" rx="3"/></svg>`
      };
      // パス種別（UNC/ドライブもファイル・フォルダに分類）とバッジ情報
      const classifyPath = (path) => {
        const p = path || "";
        const isUrl = /^https?:\/\//i.test(p);
        if (isUrl) return { type: "url", icon: typeIcon.url };
        const isUnc = /^\\\\/.test(p);
        const isDrive = /^[a-zA-Z]:\\/.test(p);
        const hasExt = /\.[a-z0-9]{1,5}$/i.test(p);
        if (isUnc || isDrive) {
          return hasExt
            ? { type: "file", icon: typeIcon.file }
            : { type: "folder", icon: typeIcon.folder };
        }
        if (hasExt) return { type: "file", icon: typeIcon.file };
        if (/[\\\/]/.test(p)) return { type: "folder", icon: typeIcon.folder };
        return { type: "unknown", icon: typeIcon.unknown };
      };
      // カテゴリ名から安定した色を生成
      const colorForCat = (cat) => {
        const key = (cat || "").split("").reduce((n, c) => n + c.charCodeAt(0)*7, 0);
        const hue = key % 360;
        const saturation = 65;
        const lightness = 60;
        const base = `hsl(${hue}deg ${saturation}% ${lightness}%)`;
        const alpha = (a) => `hsl(${hue}deg ${saturation}% ${lightness}% / ${a})`;
        return { base, alpha };
      };

      // 軽量トースト表示
      const toast = (msg) => {
        const el = $("toast");
        if (!el) return;
        el.textContent = msg;
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(()=> el.textContent = "", 1200);
      };

      // クリップボードコピー + トースト
      const copyText = async (text) => {
        await navigator.clipboard.writeText(text);
        toast("コピーしました");
      };

      // 外部データを安全な形に正規化
      const normalize = (items) => (items || []).map((x, i) => ({
        id: i + 1,
        category: safe(x.category),
        subCategory: safe(x.subCategory),
        name: safe(x.name),
        path: safe(x.path),
        note: safe(x.note)
      }));

      const state = {
        all: normalize(window.PATH_CATALOG_DATA || []),
        cat: "",
        sub: ""
      };

      const filtered = () => state.all.filter(x => {
        if (state.cat && x.category !== state.cat) return false;
        if (state.sub && x.subCategory !== state.sub) return false;
        return true;
      });

      const renderCategoryList = () => {
        const cats = sortJa(uniq(state.all.map(x => x.category).filter(Boolean)));
        const current = state.cat;

        const allBtn = `
          <button class="${current==="" ? "bg-purple-600 text-white border-purple-500 shadow" : "bg-slate-900 hover:bg-slate-800 text-slate-200 border-slate-800"} w-full text-left rounded-xl border px-3 py-1.5 text-sm"
                  data-cat="">
            すべて
          </button>`;

        $("catList").innerHTML = allBtn + cats.map(c => `
          <button class="${current===c ? "bg-purple-600 text-white border-purple-500 shadow" : "bg-slate-900 hover:bg-slate-800 text-slate-200 border-slate-800"} w-full text-left rounded-xl border px-3 py-1.5 text-sm"
                  data-cat="${escapeHtml(c)}">
            ${escapeHtml(c)}
          </button>
        `).join("");

        $("catList").querySelectorAll("button[data-cat]").forEach(btn => {
          btn.addEventListener("click", () => {
            state.cat = btn.getAttribute("data-cat") || "";
            state.sub = "";
            renderCategoryList();
            renderSubCategoryList();
            renderMain();
            closeSidebarOnMobile();
          });
        });
      };

      const renderSubCategoryList = () => {
        if (!state.cat) {
          state.sub = "";
          $("subList").innerHTML = `
            <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600">
              カテゴリを選択してください
            </div>
          `;
          return;
        }

        const base = state.all.filter(x => x.category === state.cat);
        const subs = sortJa(uniq(base.map(x => x.subCategory).filter(Boolean)));
        const current = state.sub;

        const allBtn = `
          <button class="${current==="" ? "bg-slate-800 border-slate-700 text-slate-100" : "bg-slate-900 hover:bg-slate-800 text-slate-200 border-slate-800"} w-full text-left rounded-xl border px-3 py-1.5 text-sm"
                  data-sub="">
            （すべて）
          </button>`;

        $("subList").innerHTML = allBtn + subs.map(s => `
          <button class="${current===s ? "bg-slate-800 border-slate-700 text-slate-100" : "bg-slate-900 hover:bg-slate-800 text-slate-200 border-slate-800"} w-full text-left rounded-xl border px-3 py-1.5 text-sm"
                  data-sub="${escapeHtml(s)}">
            ${escapeHtml(s)}
          </button>
        `).join("");

        $("subList").querySelectorAll("button[data-sub]").forEach(btn => {
          btn.addEventListener("click", () => {
            state.sub = btn.getAttribute("data-sub") || "";
            renderSubCategoryList();
            renderMain();
            closeSidebarOnMobile();
          });
        });
      };

      const listRow = (item) => {
        const meta = classifyPath(item.path);
        const label = (meta.type || "").toUpperCase();
        const c = colorForCat(item.category || "");
        const badgeStyle = `color:${c.base}; background-color:${c.alpha(0.12)}; border:1px solid ${c.alpha(0.25)};`;
        return `
          <li class="group cursor-pointer px-2 py-1.5 rounded-md bg-slate-900/40 hover:bg-slate-900 border border-transparent hover:border-purple-500/60 shadow-sm grid grid-cols-[150px_minmax(0,1fr)] gap-x-2 gap-y-1 items-start transition"
              data-copy="${escapeHtml(item.path)}">
            <div class="w-0.5 rounded-full bg-gradient-to-b from-purple-400 to-purple-600 opacity-30 group-hover:opacity-90 transition col-span-2"></div>
            <div class="text-[12px] font-semibold leading-snug text-slate-100 break-words">
              ${escapeHtml(item.name || "(no name)")}
            </div>
            <div class="flex items-center gap-2 text-[11px] text-slate-500 font-mono break-all tabular-nums">
              <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide border" style="${badgeStyle}" title="${label}">
                ${meta.icon || ""}
                <span class="sr-only">${label}</span>
              </span>
              <span>${escapeHtml(item.path)}</span>
            </div>
            ${item.note ? `<div class="text-[10px] text-slate-400 line-clamp-2 hidden group-hover:block col-span-2">${escapeHtml(item.note)}</div>` : ""}
          </li>
        `;
      };

      const renderMain = () => {
        const items = filtered();
        const list = $("list");
        const empty = $("empty");

        const t = $("title");
        const st = $("subtitle");
        const s1 = $("stats");
        const s2 = $("statsMobile");
        if (t) t.textContent = "";
        if (st) st.textContent = "";
        if (s1) s1.textContent = "";
        if (s2) s2.textContent = "";

        if (items.length === 0) {
          list.innerHTML = "";
          empty.classList.remove("hidden");
          return;
        }
        empty.classList.add("hidden");

        const catMap = {};
        items.forEach(item => {
          const cat = item.category || "(未設定カテゴリ)";
          const sub = item.subCategory || "(未設定)";
          if (!catMap[cat]) catMap[cat] = {};
          if (!catMap[cat][sub]) catMap[cat][sub] = [];
          catMap[cat][sub].push(item);
        });
        const catLabels = sortJa(Object.keys(catMap));

        list.innerHTML = catLabels.map(cat => {
          const color = colorForCat(cat);
          const subMap = catMap[cat];
          const subLabels = sortJa(Object.keys(subMap));
          return `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 shadow-lg ring-1 ring-slate-800/80 overflow-hidden" style="box-shadow: 0 8px 24px -12px rgba(0,0,0,0.8), 0 0 0 1px ${color.alpha(0.1)}; border-color: ${color.alpha(0.2)};">
            <div class="px-3 py-2 flex items-center gap-2 border-b border-slate-800" style="background-color: ${color.alpha(0.12)};">
              <span class="inline-block h-1 w-5 rounded-full" style="background-color:${color.base};"></span>
              <div class="text-sm font-semibold text-white leading-tight">${escapeHtml(cat)}</div>
            </div>
            <div class="p-2 grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-2 gap-2">
              ${subLabels.map(sub => `
                <div class="rounded-lg border border-slate-800 bg-slate-900/85 shadow-sm overflow-hidden" style="border-color:${color.alpha(0.2)};">
                  <div class="px-2 py-1.5 flex items-center gap-2 border-b border-slate-800/80" style="background-color:${color.alpha(0.08)};">
                    <span class="inline-flex items-center gap-2 text-[12px] font-semibold text-white tracking-wide uppercase">
                      <span class="inline-block h-1.5 w-3 rounded-full" style="background-color:${color.base};"></span>
                      ${escapeHtml(sub)}
                    </span>
                    <span class="ml-auto inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold" style="color:${color.base}; background-color:${color.alpha(0.12)}; border:1px solid ${color.alpha(0.2)};">
                      ${escapeHtml(cat)}
                    </span>
                  </div>
                  <ul class="space-y-1 border-l border-slate-800/60 pl-2">
                    ${subMap[sub].map(listRow).join("")}
                  </ul>
                </div>
              `).join("")}
            </div>
          </div>
          `;
        }).join("");

        list.querySelectorAll("li[data-copy]").forEach(el => {
          el.addEventListener("click", async () => {
            const p = el.getAttribute("data-copy") || "";
            try {
              await copyText(p);
            } catch (e) {
              const ta = document.createElement("textarea");
              ta.value = p;
              document.body.appendChild(ta);
              ta.select();
              document.execCommand("copy");
              ta.remove();
              toast("コピーしました（互換モード）");
            }
          });
        });
      };

      const renderAll = () => {
        renderCategoryList();
        renderSubCategoryList();
        renderMain();
      };

      const closeSidebarOnMobile = () => {
        if (window.matchMedia("(max-width: 767px)").matches) {
          document.querySelector("aside").classList.add("hidden");
        }
      };
      const openSidebarOnMobile = () => {
        document.querySelector("aside").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      };
      $("openSidebar").addEventListener("click", openSidebarOnMobile);
      $("toggleSidebar").addEventListener("click", closeSidebarOnMobile);

      renderAll();
    })();
  </script>
</body>
</html>
